import{S as G,e as T,b as ge,f as P,t as E,u as we,a as be,w as me,E as X,d as _e,P as x,s as D,r as ce,A as Z}from"./index-d5840571.js";var C=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},g=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,i){if(t==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?i:t==="a"?i.call(r):i?i.value:e.get(r)},I,K,p,v;function ee(r){return r!==null&&typeof r=="object"}class f{constructor(e){if(I.set(this,void 0),K.set(this,void 0),e.byteLength!==f.RAW_KEY_LENGTH)throw new Error("An Ed25519 public key must be exactly 32bytes long");C(this,I,e,"f"),C(this,K,f.derEncode(e),"f")}static from(e){if(typeof e=="string"){const t=P(e);return this.fromRaw(t)}else if(ee(e)){const t=e;if(ee(t)&&Object.hasOwnProperty.call(t,"__derEncodedPublicKey__"))return this.fromDer(t);if(ArrayBuffer.isView(t)){const i=t;return this.fromRaw(be(i.buffer))}else{if(t instanceof ArrayBuffer)return this.fromRaw(t);if("rawKey"in t)return this.fromRaw(t.rawKey);if("derKey"in t)return this.fromDer(t.derKey);if("toDer"in t)return this.fromDer(t.toDer())}}throw new Error("Cannot construct Ed25519PublicKey from the provided key.")}static fromRaw(e){return new f(e)}static fromDer(e){return new f(this.derDecode(e))}static derEncode(e){const t=me(e,X).buffer;return t.__derEncodedPublicKey__=void 0,t}static derDecode(e){const t=_e(e,X);if(t.length!==this.RAW_KEY_LENGTH)throw new Error("An Ed25519 public key must be exactly 32bytes long");return t}get rawKey(){return g(this,I,"f")}get derKey(){return g(this,K,"f")}toDer(){return this.derKey}toRaw(){return this.rawKey}}I=new WeakMap,K=new WeakMap;f.RAW_KEY_LENGTH=32;class m extends G{constructor(e,t){super(),p.set(this,void 0),v.set(this,void 0),C(this,p,f.from(e),"f"),C(this,v,new Uint8Array(t),"f")}static generate(e){if(e&&e.length!==32)throw new Error("Ed25519 Seed needs to be 32 bytes long.");e||(e=T.utils.randomPrivateKey()),ge(e,new Uint8Array(new Array(32).fill(0)))&&console.warn("Seed is all zeros. This is not a secure seed. Please provide a seed with sufficient entropy if this is a production environment.");const t=new Uint8Array(32);for(let n=0;n<32;n++)t[n]=new Uint8Array(e)[n];const i=T.getPublicKey(t);return m.fromKeyPair(i,t)}static fromParsedJson(e){const[t,i]=e;return new m(f.fromDer(P(t)),P(i))}static fromJSON(e){const t=JSON.parse(e);if(Array.isArray(t)){if(typeof t[0]=="string"&&typeof t[1]=="string")return this.fromParsedJson([t[0],t[1]]);throw new Error("Deserialization error: JSON must have at least 2 items.")}throw new Error(`Deserialization error: Invalid JSON type for string: ${JSON.stringify(e)}`)}static fromKeyPair(e,t){return new m(f.fromRaw(e),t)}static fromSecretKey(e){const t=T.getPublicKey(new Uint8Array(e));return m.fromKeyPair(t,e)}toJSON(){return[E(g(this,p,"f").toDer()),E(g(this,v,"f"))]}getKeyPair(){return{secretKey:g(this,v,"f"),publicKey:g(this,p,"f")}}getPublicKey(){return g(this,p,"f")}async sign(e){const t=new Uint8Array(e),i=we(T.sign(t,g(this,v,"f").slice(0,32)));return Object.defineProperty(i,"__signature__",{enumerable:!1,value:void 0}),i}static verify(e,t,i){const[n,a,s]=[e,t,i].map(o=>(typeof o=="string"&&(o=P(o)),o instanceof Uint8Array&&(o=o.buffer),new Uint8Array(o)));return T.verify(a,n,s)}}p=new WeakMap,v=new WeakMap;class z extends Error{constructor(e){super(e),this.message=e,Object.setPrototypeOf(this,z.prototype)}}function te(r){if(typeof global<"u"&&global.crypto&&global.crypto.subtle)return global.crypto.subtle;if(r)return r;if(typeof crypto<"u"&&crypto.subtle)return crypto.subtle;throw new z("Global crypto was not available and none was provided. Please inlcude a SubtleCrypto implementation. See https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto")}class L extends G{constructor(e,t,i){super(),this._keyPair=e,this._derKey=t,this._subtleCrypto=i}static async generate(e){const{extractable:t=!1,keyUsages:i=["sign","verify"],subtleCrypto:n}=e??{},a=te(n),s=await a.generateKey({name:"ECDSA",namedCurve:"P-256"},t,i),o=await a.exportKey("spki",s.publicKey);return new this(s,o,a)}static async fromKeyPair(e,t){const i=te(t),n=await i.exportKey("spki",e.publicKey);return new L(e,n,i)}getKeyPair(){return this._keyPair}getPublicKey(){const e=this._derKey,t=Object.create(this._keyPair.publicKey);return t.toDer=function(){return e},t}async sign(e){const t={name:"ECDSA",hash:{name:"SHA-256"}};return await this._subtleCrypto.sign(t,this._keyPair.privateKey,e)}}var pe=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},S=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,i){if(t==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?i:t==="a"?i.call(r):i?i.value:e.get(r)},y;class ve{constructor(e){y.set(this,void 0),pe(this,y,e,"f")}get rawKey(){return S(this,y,"f").rawKey}get derKey(){return S(this,y,"f").derKey}toDer(){return S(this,y,"f").toDer()}getPublicKey(){return S(this,y,"f")}getPrincipal(){return x.from(S(this,y,"f").rawKey)}transformRequest(){return Promise.reject("Not implemented. You are attempting to use a partial identity to sign calls, but this identity only has access to the public key.To sign calls, use a DelegationIdentity instead.")}}y=new WeakMap;var Ee=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},Te=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,i){if(t==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?i:t==="a"?i.call(r):i?i.value:e.get(r)},De=globalThis&&globalThis.__rest||function(r,e){var t={};for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&e.indexOf(i)<0&&(t[i]=r[i]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,i=Object.getOwnPropertySymbols(r);n<i.length;n++)e.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(r,i[n])&&(t[i[n]]=r[i[n]]);return t},O;const Se=new TextEncoder().encode("ic-request-auth-delegation"),Pe=new TextEncoder().encode(`
ic-request`);function R(r){if(typeof r!="string"||r.length<64)throw new Error("Invalid public key.");return P(r)}class Y{constructor(e,t,i){this.pubkey=e,this.expiration=t,this.targets=i}toCBOR(){return D.value.map(Object.assign({pubkey:D.value.bytes(this.pubkey),expiration:D.value.u64(this.expiration.toString(16),16)},this.targets&&{targets:D.value.array(this.targets.map(e=>D.value.bytes(e.toUint8Array())))}))}toJSON(){return Object.assign({expiration:this.expiration.toString(16),pubkey:E(this.pubkey)},this.targets&&{targets:this.targets.map(e=>e.toHex())})}}async function Ie(r,e,t,i){const n=new Y(e.toDer(),BigInt(+t)*BigInt(1e6),i),a=new Uint8Array([...Se,...new Uint8Array(ce(n))]),s=await r.sign(a);return{delegation:n,signature:s}}class k{constructor(e,t){this.delegations=e,this.publicKey=t}static async create(e,t,i=new Date(Date.now()+15*60*1e3),n={}){var a,s;const o=await Ie(e,t,i,n.targets);return new k([...((a=n.previous)===null||a===void 0?void 0:a.delegations)||[],o],((s=n.previous)===null||s===void 0?void 0:s.publicKey)||e.getPublicKey().toDer())}static fromJSON(e){const{publicKey:t,delegations:i}=typeof e=="string"?JSON.parse(e):e;if(!Array.isArray(i))throw new Error("Invalid delegations.");const n=i.map(a=>{const{delegation:s,signature:o}=a,{pubkey:l,expiration:c,targets:u}=s;if(u!==void 0&&!Array.isArray(u))throw new Error("Invalid targets.");return{delegation:new Y(R(l),BigInt("0x"+c),u&&u.map(d=>{if(typeof d!="string")throw new Error("Invalid target.");return x.fromHex(d)})),signature:R(o)}});return new this(n,R(t))}static fromDelegations(e,t){return new this(e,t)}toJSON(){return{delegations:this.delegations.map(e=>{const{delegation:t,signature:i}=e,{targets:n}=t;return{delegation:Object.assign({expiration:t.expiration.toString(16),pubkey:E(t.pubkey)},n&&{targets:n.map(a=>a.toHex())}),signature:E(i)}}),publicKey:E(this.publicKey)}}}class re extends G{constructor(e,t){super(),this._inner=e,this._delegation=t}static fromDelegation(e,t){return new this(e,t)}getDelegation(){return this._delegation}getPublicKey(){return{derKey:this._delegation.publicKey,toDer:()=>this._delegation.publicKey}}sign(e){return this._inner.sign(e)}async transformRequest(e){const{body:t}=e,i=De(e,["body"]),n=await ce(t);return Object.assign(Object.assign({},i),{body:{content:t,sender_sig:await this.sign(new Uint8Array([...Pe,...new Uint8Array(n)])),sender_delegation:this._delegation.delegations,sender_pubkey:this._delegation.publicKey}})}}class N extends ve{constructor(e,t){super(e),O.set(this,void 0),Ee(this,O,t,"f")}get delegation(){return Te(this,O,"f")}static fromDelegation(e,t){return new N(e,t)}}O=new WeakMap;function Ke(r,e){for(const{delegation:n}of r.delegations)if(+new Date(Number(n.expiration/BigInt(1e6)))<=+Date.now())return!1;const t=[],i=e==null?void 0:e.scope;i&&(Array.isArray(i)?t.push(...i.map(n=>typeof n=="string"?x.fromText(n):n)):t.push(typeof i=="string"?x.fromText(i):i));for(const n of t){const a=n.toText();for(const{delegation:s}of r.delegations){if(s.targets===void 0)continue;let o=!0;for(const l of s.targets)if(l.toText()===a){o=!1;break}if(o)return!1}}return!0}var ie;(function(r){r[r.ECDSA_WITH_SHA256=-7]="ECDSA_WITH_SHA256"})(ie||(ie={}));const ne=["mousedown","mousemove","keydown","touchstart","wheel"];class oe{constructor(e={}){var t;this.callbacks=[],this.idleTimeout=10*60*1e3,this.timeoutID=void 0;const{onIdle:i,idleTimeout:n=10*60*1e3}=e||{};this.callbacks=i?[i]:[],this.idleTimeout=n;const a=this._resetTimer.bind(this);window.addEventListener("load",a,!0),ne.forEach(function(o){document.addEventListener(o,a,!0)});const s=(o,l)=>{let c;return(...u)=>{const d=this,h=function(){c=void 0,o.apply(d,u)};clearTimeout(c),c=window.setTimeout(h,l)}};if(e!=null&&e.captureScroll){const o=s(a,(t=e==null?void 0:e.scrollDebounce)!==null&&t!==void 0?t:100);window.addEventListener("scroll",o,!0)}a()}static create(e={}){return new this(e)}registerCallback(e){this.callbacks.push(e)}exit(){clearTimeout(this.timeoutID),window.removeEventListener("load",this._resetTimer,!0);const e=this._resetTimer.bind(this);ne.forEach(function(t){document.removeEventListener(t,e,!0)}),this.callbacks.forEach(t=>t())}_resetTimer(){const e=this.exit.bind(this);window.clearTimeout(this.timeoutID),this.timeoutID=window.setTimeout(e,this.idleTimeout)}}const Oe=(r,e)=>e.some(t=>r instanceof t);let ae,se;function Ae(){return ae||(ae=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function xe(){return se||(se=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const de=new WeakMap,J=new WeakMap,ue=new WeakMap,j=new WeakMap,$=new WeakMap;function Ce(r){const e=new Promise((t,i)=>{const n=()=>{r.removeEventListener("success",a),r.removeEventListener("error",s)},a=()=>{t(_(r.result)),n()},s=()=>{i(r.error),n()};r.addEventListener("success",a),r.addEventListener("error",s)});return e.then(t=>{t instanceof IDBCursor&&de.set(t,r)}).catch(()=>{}),$.set(e,r),e}function Le(r){if(J.has(r))return;const e=new Promise((t,i)=>{const n=()=>{r.removeEventListener("complete",a),r.removeEventListener("error",s),r.removeEventListener("abort",s)},a=()=>{t(),n()},s=()=>{i(r.error||new DOMException("AbortError","AbortError")),n()};r.addEventListener("complete",a),r.addEventListener("error",s),r.addEventListener("abort",s)});J.set(r,e)}let V={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return J.get(r);if(e==="objectStoreNames")return r.objectStoreNames||ue.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return _(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function ke(r){V=r(V)}function Ne(r){return r===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const i=r.call(M(this),e,...t);return ue.set(i,e.sort?e.sort():[e]),_(i)}:xe().includes(r)?function(...e){return r.apply(M(this),e),_(de.get(this))}:function(...e){return _(r.apply(M(this),e))}}function Be(r){return typeof r=="function"?Ne(r):(r instanceof IDBTransaction&&Le(r),Oe(r,Ae())?new Proxy(r,V):r)}function _(r){if(r instanceof IDBRequest)return Ce(r);if(j.has(r))return j.get(r);const e=Be(r);return e!==r&&(j.set(r,e),$.set(e,r)),e}const M=r=>$.get(r);function Re(r,e,{blocked:t,upgrade:i,blocking:n,terminated:a}={}){const s=indexedDB.open(r,e),o=_(s);return i&&s.addEventListener("upgradeneeded",l=>{i(_(s.result),l.oldVersion,l.newVersion,_(s.transaction),l)}),t&&s.addEventListener("blocked",l=>t(l.oldVersion,l.newVersion,l)),o.then(l=>{a&&l.addEventListener("close",()=>a()),n&&l.addEventListener("versionchange",c=>n(c.oldVersion,c.newVersion,c))}).catch(()=>{}),o}const je=["get","getKey","getAll","getAllKeys","count"],Me=["put","add","delete","clear"],W=new Map;function le(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(W.get(e))return W.get(e);const t=e.replace(/FromIndex$/,""),i=e!==t,n=Me.includes(t);if(!(t in(i?IDBIndex:IDBObjectStore).prototype)||!(n||je.includes(t)))return;const a=async function(s,...o){const l=this.transaction(s,n?"readwrite":"readonly");let c=l.store;return i&&(c=c.index(o.shift())),(await Promise.all([c[t](...o),n&&l.done]))[0]};return W.set(e,a),a}ke(r=>({...r,get:(e,t,i)=>le(e,t)||r.get(e,t,i),has:(e,t)=>!!le(e,t)||r.has(e,t)}));const he="auth-client-db",fe="ic-keyval",We=async(r=he,e=fe,t)=>(ye&&(localStorage!=null&&localStorage.getItem(b))&&(localStorage.removeItem(b),localStorage.removeItem(w)),await Re(r,t,{upgrade:i=>{i.objectStoreNames.contains(e)&&i.clear(e),i.createObjectStore(e)}}));async function Fe(r,e,t){return await r.get(e,t)}async function He(r,e,t,i){return await r.put(e,i,t)}async function Ue(r,e,t){return await r.delete(e,t)}class q{constructor(e,t){this._db=e,this._storeName=t}static async create(e){const{dbName:t=he,storeName:i=fe,version:n=ze}=e??{},a=await We(t,i,n);return new q(a,i)}async set(e,t){return await He(this._db,this._storeName,e,t)}async get(e){var t;return(t=await Fe(this._db,this._storeName,e))!==null&&t!==void 0?t:null}async remove(e){return await Ue(this._db,this._storeName,e)}}var Je=globalThis&&globalThis.__classPrivateFieldSet||function(r,e,t,i,n){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t},Ve=globalThis&&globalThis.__classPrivateFieldGet||function(r,e,t,i){if(t==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!i:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?i:t==="a"?i.call(r):i?i.value:e.get(r)},A;const w="identity",b="delegation",Ge="iv",ze=1,ye=typeof window<"u";class Ye{constructor(e="ic-",t){this.prefix=e,this._localStorage=t}get(e){return Promise.resolve(this._getLocalStorage().getItem(this.prefix+e))}set(e,t){return this._getLocalStorage().setItem(this.prefix+e,t),Promise.resolve()}remove(e){return this._getLocalStorage().removeItem(this.prefix+e),Promise.resolve()}_getLocalStorage(){if(this._localStorage)return this._localStorage;const e=typeof window>"u"?typeof global>"u"?typeof self>"u"?void 0:self.localStorage:global.localStorage:window.localStorage;if(!e)throw new Error("Could not find local storage.");return e}}class $e{constructor(e){A.set(this,void 0),Je(this,A,e??{},"f")}get _db(){return new Promise(e=>{if(this.initializedDb){e(this.initializedDb);return}q.create(Ve(this,A,"f")).then(t=>{this.initializedDb=t,e(t)})})}async get(e){return await(await this._db).get(e)}async set(e,t){await(await this._db).set(e,t)}async remove(e){await(await this._db).remove(e)}}A=new WeakMap;const qe="https://identity.ic0.app",Qe="#authorize",F="ECDSA",H="Ed25519",Xe=500,Ze="UserInterrupt";class tt{constructor(e,t,i,n,a,s,o,l){this._identity=e,this._key=t,this._chain=i,this._storage=n,this.idleManager=a,this._createOptions=s,this._idpWindow=o,this._eventHandler=l,this._registerDefaultIdleCallback()}static async create(e={}){var t,i,n;const a=(t=e.storage)!==null&&t!==void 0?t:new $e,s=(i=e.keyType)!==null&&i!==void 0?i:F;let o=null;if(e.identity)o=e.identity;else{let d=await a.get(w);if(!d&&ye)try{const h=new Ye,B=await h.get(b),Q=await h.get(w);B&&Q&&s===F&&(console.log("Discovered an identity stored in localstorage. Migrating to IndexedDB"),await a.set(b,B),await a.set(w,Q),d=B,await h.remove(b),await h.remove(w))}catch(h){console.error("error while attempting to recover localstorage: "+h)}if(d)try{typeof d=="object"?s===H&&typeof d=="string"?o=await m.fromJSON(d):o=await L.fromKeyPair(d):typeof d=="string"&&(o=m.fromJSON(d))}catch{}}let l=new Z,c=null;if(o)try{const d=await a.get(b);if(typeof d=="object"&&d!==null)throw new Error("Delegation chain is incorrectly stored. A delegation chain should be stored as a string.");e.identity?l=e.identity:d&&(c=k.fromJSON(d),Ke(c)?"toDer"in o?l=N.fromDelegation(o,c):l=re.fromDelegation(o,c):(await U(a),o=null))}catch(d){console.error(d),await U(a),o=null}let u;return!((n=e.idleOptions)===null||n===void 0)&&n.disableIdle?u=void 0:(c||e.identity)&&(u=oe.create(e.idleOptions)),o||(s===H?(o=await m.generate(),await a.set(w,JSON.stringify(o.toJSON()))):(e.storage&&s===F&&console.warn(`You are using a custom storage provider that may not support CryptoKey storage. If you are using a custom storage provider that does not support CryptoKey storage, you should use '${H}' as the key type, as it can serialize to a string`),o=await L.generate(),await a.set(w,o.getKeyPair()))),new this(l,o,c,a,u,e)}_registerDefaultIdleCallback(){var e,t;const i=(e=this._createOptions)===null||e===void 0?void 0:e.idleOptions;!(i!=null&&i.onIdle)&&!(i!=null&&i.disableDefaultIdleCallback)&&((t=this.idleManager)===null||t===void 0||t.registerCallback(()=>{this.logout(),location.reload()}))}async _handleSuccess(e,t){var i,n;const a=e.delegations.map(c=>({delegation:new Y(c.delegation.pubkey,c.delegation.expiration,c.delegation.targets),signature:c.signature.buffer})),s=k.fromDelegations(a,e.userPublicKey.buffer),o=this._key;if(!o)return;this._chain=s,"toDer"in o?this._identity=N.fromDelegation(o,this._chain):this._identity=re.fromDelegation(o,this._chain),(i=this._idpWindow)===null||i===void 0||i.close();const l=(n=this._createOptions)===null||n===void 0?void 0:n.idleOptions;!this.idleManager&&!(l!=null&&l.disableIdle)&&(this.idleManager=oe.create(l),this._registerDefaultIdleCallback()),this._removeEventListener(),delete this._idpWindow,this._chain&&await this._storage.set(b,JSON.stringify(this._chain.toJSON())),t==null||t(e)}getIdentity(){return this._identity}async isAuthenticated(){return!this.getIdentity().getPrincipal().isAnonymous()&&this._chain!==null}async login(e){var t,i,n,a;const s=BigInt(8)*BigInt(36e11),o=new URL(((t=e==null?void 0:e.identityProvider)===null||t===void 0?void 0:t.toString())||qe);o.hash=Qe,(i=this._idpWindow)===null||i===void 0||i.close(),this._removeEventListener(),this._eventHandler=this._getEventHandler(o,Object.assign({maxTimeToLive:(n=e==null?void 0:e.maxTimeToLive)!==null&&n!==void 0?n:s},e)),window.addEventListener("message",this._eventHandler),this._idpWindow=(a=window.open(o.toString(),"idpWindow",e==null?void 0:e.windowOpenerFeatures))!==null&&a!==void 0?a:void 0;const l=()=>{this._idpWindow&&(this._idpWindow.closed?this._handleFailure(Ze,e==null?void 0:e.onError):setTimeout(l,Xe))};l()}_getEventHandler(e,t){return async i=>{var n,a,s;if(i.origin!==e.origin){console.warn(`WARNING: expected origin '${e.origin}', got '${i.origin}' (ignoring)`);return}const o=i.data;switch(o.kind){case"authorize-ready":{const l=Object.assign({kind:"authorize-client",sessionPublicKey:new Uint8Array((n=this._key)===null||n===void 0?void 0:n.getPublicKey().toDer()),maxTimeToLive:t==null?void 0:t.maxTimeToLive,allowPinAuthentication:t==null?void 0:t.allowPinAuthentication,derivationOrigin:(a=t==null?void 0:t.derivationOrigin)===null||a===void 0?void 0:a.toString()},t==null?void 0:t.customValues);(s=this._idpWindow)===null||s===void 0||s.postMessage(l,e.origin);break}case"authorize-client-success":try{await this._handleSuccess(o,t==null?void 0:t.onSuccess)}catch(l){this._handleFailure(l.message,t==null?void 0:t.onError)}break;case"authorize-client-failure":this._handleFailure(o.text,t==null?void 0:t.onError);break}}}_handleFailure(e,t){var i;(i=this._idpWindow)===null||i===void 0||i.close(),t==null||t(e),this._removeEventListener(),delete this._idpWindow}_removeEventListener(){this._eventHandler&&window.removeEventListener("message",this._eventHandler),this._eventHandler=void 0}async logout(e={}){if(await U(this._storage),this._identity=new Z,this._chain=null,e.returnTo)try{window.history.pushState({},"",e.returnTo)}catch{window.location.href=e.returnTo}}}async function U(r){await r.remove(w),await r.remove(b),await r.remove(Ge)}export{tt as A};
