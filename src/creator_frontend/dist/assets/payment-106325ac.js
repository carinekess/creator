import{b as E,r,u as M,j as e,R as I,C as i,B as R}from"./index-43d0fa9b.js";import{c as A,a as U,F as $}from"./index.esm-4e84dfba.js";import{c as p}from"./index-d5840571.js";import{s as B,i as L}from"./hdev_payment-357b68b9.js";import{S as H}from"./Spinner-c61f8477.js";import{A as g}from"./Alert-294d6ed2.js";import{R as y,C as w}from"./Row-fefb1cc1.js";import{F as d}from"./Form-ec4a912c.js";import"./CloseButton-102e4345.js";const Q=()=>{const{artwork_id:x}=E(),[n,P]=r.useState(null),[f,S]=r.useState(null),[b,_]=r.useState(null),[k,N]=r.useState(!0),[h,m]=r.useState(""),[j,C]=r.useState(""),v=M();r.useEffect(()=>{const o=async()=>{try{const t=await p.getArtworkDetails(Number(x));if(t){P(t[0]);const l=(await p.getClients()).find(a=>a.id===t[0].client_id);S(l)}}catch{m("Could not fetch artwork details. Please try again later.")}finally{N(!1)}},c=()=>{const t=localStorage.getItem("user");t?_(JSON.parse(t)):m("No logged-in user found. Please log in.")};o(),c()},[x]);const F=async(o,{setSubmitting:c})=>{if(!b){m("You must be logged in to make a payment."),c(!1);return}const t=new Date().toISOString(),s=Math.random().toString(36).substring(2,14),l=`${window.location.origin}/receipt/${s}/view`;try{const a=await B("HDEV-90621992-dc1c-4aa0-b5ff-5c393649ecf5-ID","HDEV-6a11e9c7-009b-45d7-87d6-3c5507c3fbc2-KEY"),u=await L(o.phone_number,n.price,s,l);console.log(u),u.status==="success"?(await p.addPayment(Math.floor(Math.random()*1e6),Number(b.id),Number(n.artwork_id),Number(n.price),t,o.phone_number,"none",s,"pending"),C("Payment initiated, waiting for confirmation..."),setTimeout(()=>v(`/waiting/${s}`),1e3)):m(u.message||"Payment failed.")}catch(a){console.error("Payment error:",a),m("Payment failed. Please try again.")}finally{c(!1)}},D=A().shape({phone_number:U().required("Phone number is required")});return e.jsx(I.Fragment,{children:k?e.jsx("div",{className:"text-center",children:e.jsx(H,{animation:"border",variant:"primary"})}):h?e.jsx(g,{variant:"danger",className:"text-center",children:h}):e.jsxs(e.Fragment,{children:[e.jsx(y,{children:e.jsx(w,{children:e.jsxs(i,{className:"mb-4",children:[e.jsxs(i.Body,{children:[e.jsx("h5",{className:"mb-3",children:n.title})," ",e.jsx("p",{children:n.description})," ",e.jsxs("h4",{className:"f-w-300 m-b-0",children:[parseFloat(n.price).toFixed(2)," Frw"]})," "]}),e.jsxs(i.Footer,{children:[e.jsxs("small",{children:["Client: ",f?f.name:"Unknown"]})," "]})]})})}),e.jsx(y,{children:e.jsx(w,{sm:12,children:e.jsxs(i,{children:[e.jsxs(i.Header,{children:[e.jsxs(i.Title,{as:"h5",children:["Make Payment for ",n.title]})," "]}),e.jsxs(i.Body,{children:[j&&e.jsx(g,{variant:"success",children:j}),h&&e.jsx(g,{variant:"danger",children:h}),e.jsx($,{initialValues:{phone_number:""},validationSchema:D,onSubmit:F,children:({values:o,handleChange:c,handleSubmit:t,errors:s,touched:l,isSubmitting:a})=>e.jsxs(d,{onSubmit:t,children:[e.jsxs(d.Group,{className:"mb-3",children:[e.jsx(d.Label,{children:"Phone Number"}),e.jsx(d.Control,{type:"text",name:"phone_number",placeholder:"Enter your phone number",value:o.phone_number,onChange:c,isInvalid:!!l.phone_number&&!!s.phone_number}),l.phone_number&&s.phone_number&&e.jsx(d.Control.Feedback,{type:"invalid",children:s.phone_number})]}),e.jsx(R,{variant:"primary",type:"submit",disabled:a,children:a?"Processing...":"Pay Now"})]})})]})]})})})]})})};export{Q as default};
